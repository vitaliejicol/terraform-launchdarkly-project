name: Terraform Module Release

permissions:
  contents: write
  id-token: write

on:
  push:
    branches:
      - main
    paths:
      - '**/*.tpl'
      - '**/*.py'
      - '**/*.tf'
      - '.github/workflows/release.yml'
  workflow_dispatch:

jobs:
  release:
    name: Release Module
    runs-on: ubuntu-latest

    # Skip running release workflow on forks for semantic-release
    # if: github.repository_owner == 'terraform-launchdarkly-project'

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Git user
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Generate Terraform Docs (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: terraform-docs/gh-actions@v1
        with:
          output-file: README.md
          output-method: inject
          config-file: .terraform-docs.yml

      # - name: Commit updated docs (on tag push)
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     git add README.md
      #     if git diff --cached --quiet; then
      #       echo "No changes to commit"
      #     else
      #       git commit -m "chore(docs): update README with terraform-docs"
      #       git push origin main
      #     fi

      - name: Semantic Release (on branch pushes or manual trigger)
        if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/v')
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 23.0.2
          extra_plugins: |
            @semantic-release/changelog@6.0.3
            @semantic-release/git@10.0.1
            conventional-changelog-conventionalcommits@7.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
